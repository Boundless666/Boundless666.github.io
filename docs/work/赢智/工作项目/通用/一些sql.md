## 销售模块

#### 查询同订单同序号的销货记录

**表中数据**

| 订单单号     | 订单序号 | 品号   | 品名              | 销货日期   | 销货数量 |
| ------------ | -------- | ------ | ----------------- | ---------- | -------- |
| 202310270101 | 001      | XC0004 | T-12.7防，槽，N槽 | 2023-10-28 | 20       |
| 202310270101 | 002      | XC0004 | T-12.7防，槽，N槽 | 2023-10-28 | 12       |
| 202310270101 | 002      | XC0004 | T-12.7防，槽，N槽 | 2023-10-27 | 23       |
| 202310270101 | 003      | XC0043 | T-12.7防，槽，N槽 | 2023-10-26 | 15       |

**希望查出来的数据如下** `同品号 同序号的合并 并水平排列`

| 订单单号     | 订单序号 | 品号   | 品名              | 第一次销货日期 | 第一次销货数量 | 第二次销货日期 | 第二次销货数量 |
| ------------ | -------- | ------ | ----------------- | -------------- | -------------- | -------------- | -------------- |
| 202310270101 | 001      | XC0004 | T-12.7防，槽，N槽 | 2023-10-28     | 20             |                |                |
| 202310270101 | 002      | XC0004 | T-12.7防，槽，N槽 | 2023-10-27     | 23             | 2023-10-28     | 12             |
| 202310270101 | 003      | XC0043 | T-12.7防，槽，N槽 | 2023-10-26     | 15             |                |                |

```sql
WITH CTE AS (
    SELECT t1.*,
    ROW_NUMBER() OVER(PARTITION BY 订单号, 订单序号 ORDER BY 销货时间) AS rn
    FROM (
		SELECT 
			ibb.IBB001 订单号,ibb.IBB002 订单序号, ibb.IBB003 品号, ibb.IBB004 品名, keb.KEB007 销货数量,keb.KEB902 销货时间,ibb.IBB902 订单时间
		FROM dbo.DCSIBB ibb
		LEFT JOIN dbo.JSKKEB keb ON ibb.IBB001 = keb.KEB016 AND ibb.IBB002 = keb.KEB017
		WHERE keb.KEB001 IS NOT NULL
	) t1
)
SELECT
	tb1.订单号,tb1.订单序号,tb1.品号,tb1.品名, tb1.订单时间,
	tb1.销货时间 第一次销货时间, ISNULL(CAST(tb1.销货数量 AS VARCHAR(12)), '') 第一次销货数量,
	tb2.销货时间 第二次销货时间, ISNULL(CAST(tb2.销货数量 AS VARCHAR(12)), '') 第二次销货数量,
	tb3.销货时间 第三次销货时间, ISNULL(CAST(tb3.销货数量 AS VARCHAR(12)), '') 第三次销货数量
FROM (SELECT * FROM CTE WHERE rn = 1) tb1
LEFT JOIN CTE tb2 ON tb1.订单号 = tb2.订单号 AND tb1.订单序号 = tb2.订单序号 AND tb2.rn = 2
LEFT JOIN CTE tb3 ON tb1.订单号 = tb3.订单号 AND tb1.订单序号 = tb3.订单序号 AND tb3.rn = 3
WHERE tb2.销货数量 IS NOT NULL
ORDER BY tb1.订单时间 DESC
```

